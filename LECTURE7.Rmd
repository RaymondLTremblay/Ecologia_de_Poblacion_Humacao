---
title: "Modelos de matrices poblacionales "
author: "BIOL4558"
date: "Agosto 2021"
output: 
  html_document: 
    theme: spacelab
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```


```{r echo=FALSE}

############################################################
####                                                    ####  
####  BIOL4558, Topico 7                               ####
####                                                    ####
####  Kevin Shoemaker                                   #### 
####  University of Nevada, Reno                    ####
####        &                           ####
####  Raymond L. Tremblay       ####
####  Universidad de Puerto Rico                   ####
####                                                    #### 
############################################################


############################################################
####  Matrix population models                          ####
############################################################


```


### Próximo examen parcial

**cuándo y dónde** El primer examen parcial (de dos) se realizará el lunes **15 de marzo**. Tendrás todo el período de clase de 120 minutos para realizar el examen. El examen será en línea (por supuesto) y se administrará en Edmodo.


**qué ** El examen cubrirá:

- Todo el material de los capítulos 1-3 del libro de Gotelli *incluidos los conceptos de modelos de población matricial *.
- Todo el material cubierto en conferencias hasta e incluyendo esta conferencia sobre modelos matriciales de población.
- Ch. 1 de "Beyond Connecting the Dots" (pensamiento sistémico básico y modelado de flujo de existencias, conceptos de retroalimentación y equilibrios)
- Conceptos básicos de programación (IF-THEN-ELSE y de iteración)

*El examen consistirá en una combinación de preguntas de opción múltiple y de respuesta corta.*

*Por favor traiga una calculadora; una calculadora científica normal está bien (no es absolutamente necesaria, ¡pero podría ser útil para al menos una pregunta del examen!)*


# Matrix population models

En primer lugar, esta lección está llena de código R (¡R es bastante bueno para ejecutar modelos de población matricial!). Si desea seguir en R, puede encontrar el script R [aquí](LECTURE7.R). Recomiendo hacer clic derecho en el enlace, guardar el script en una carpeta designada y cargar el script en RStudio.    

## ¿Por qué matrices?

### Reason 1: simplify!

![](IM8.jpg)

Es posible que reconozca este modelo de InsightMaker. Esto representa una población estructurada por edad con solo tres clases de edad. Imagínese si hubiera cinco clases de edad o diez. ¿Qué pasaría si pudieras saltar de (por ejemplo) la etapa 3 a la etapa 5? ¿O de la etapa 5 a la etapa 3? ¿Cuántas líneas tendrías que dibujar, cuántas ecuaciones tendrías que poner en todos los diferentes flujos? Sería tedioso y fácilmente podría encontrarse con errores que serían muy difíciles de depurar. 

![](teasel1.jpg)

Considere el ejemplo del teasel de nuestro libro de texto. Es posible implementar este modelo en InsightMaker, pero sería tedioso y potencialmente propenso a errores. Y esto está lejos de las poblaciones más complicadas que existen (aunque observe que las plantas pueden hacer algunas cosas que los animales no pueden hacer, por ejemplo, retroceder en la etapa de desarrollo. ¡Con los modelos matriciales, hay una manera más fácil!

![](gotelli3_6.jpg)

Las tasas vitales de la población para casi cualquier población estructurada por edad o estructurada por etapas se pueden representar como una **matriz de transición** (o matriz de proyección), que resume toda la información sobre mortalidad, tasas de natalidad y transiciones entre etapas. (¡y el hecho de que una historia de vida como Teasel pueda representarse mediante una matriz de transición ilustra la generalidad de este concepto!)

Por ejemplo, las tasas vitales de teasel se pueden resumir en [esta matriz](teaselmatrix1.csv):

```{r}

#########
# Teasel example from Gotelli: summarizing a complex life history!

teasel <- read.csv("teaselmatrix1.csv", header=T)      # read in the teasel transition matrix from Gotelli
teasel <- teasel[,-1]                                  # remove the row names
teasel_matrix <- as.matrix(teasel)                     # convert to a matrix (from a data frame)
colnames(teasel_matrix) <- names(teasel)               # assign row and column names
rownames(teasel_matrix) <- names(teasel)
teasel_matrix                                          # print the matrix

```


¿No es eso *elegante \*?

¡Entraremos en más detalles sobre las matrices más adelante!


### Supplementario: Matrices estructura por etapas vs. estructura por edades


En la conferencia anterior, hablamos de 'poblaciones estructuradas por edad'. Lo que queremos decir con eso es que las tasas vitales de la población (por ejemplo, nacimiento y mortandad) variaban según la edad.


A veces, es conveniente clasificar a los individuos dentro de un cierto rango de edad como pertenecientes a una etapa particular de su historia de vida. Por ejemplo, podríamos clasificar la historia de vida de un oso pardo así:

Edad 0-1: recien nacidos     
Edad 1-2: juveniles     
Edad 2-5: sub-adulto     
Edad 6+: adulto     

Esto puede simplificar nuestros modelos considerablemente. Por ejemplo, considere una especie como una tortuga marina, con hasta 75 o 100 años de vida. Podría construir un modelo en el que tenga 100 acciones, una por cada año de vida. O, podría tener 5 o más poblaciones que representen rangos de edad en los que las tortugas marinas tienden a tener tasas vitales consistentes (mas o menos). Por ejemplo, podríamos dividir la historia de vida de las tortugas marinas en las siguientes etapas: 

Edad 0-1: recien nacidos      
Edad 1-5: juveniles joven     
Edad 5-10: juvenile más grandes     
Edad 10-17: sub-adult0      
Edad 18+: adult0      

Al usar etapas, hemos simplificado nuestro modelo de tener 100 acciones (con aún más flujos / transiciones asociadas) a un modelo con solo 5 acciones, y todavía estamos capturando cómo cambian las tasas vitales con la edad (el modelo sigue siendo biológicamente realista).


Los modelos matriciales de población pueden representar modelos estructurados por edades y estructurados por etapas con la misma simplicidad y elegancia.

La 'Leslie Matrix' comúnmente utilizada se refiere a un modelo de población matricial que representa una población estructurada por edad. Cuando se utiliza una matriz para representar una población estructurada por etapas, a menudo se la denomina Matriz 'Lefkovitch'.

### Razón 2: ¡proyección!

En una de las preguntas del laboratorio 3, se le pidió que usara una tabla de vida para proyectar la estructura de edad de una población en un paso de tiempo en el futuro. ¿Fue sencillo y directo hacer esto? (respuesta: ¡¡NO !!)

Las tablas de vida son excelentes para resumir los cronogramas de supervivencia y otros aspectos de las poblaciones estructuradas por edad. ¡Pero las _tablas de vida no son excelentes para proyectar la abundancia estructurada por edades en el futuro_!

¿Sabes qué *es* genial para proyectar la abundancia estructurada por edades en el futuro? (respuesta obvia: MATRICES!)

Por ejemplo, proyectemos una población de teasel 1 año en el futuro:

En primer lugar, debemos comenzar con una población de teasel **vector ** ...

```{r}

#############
# Summarize initial age-structured abundance as a matrix with one column

Initial_teasel <- matrix(c(1000,1500,200,300,600,25),ncol=1)         # initial population size (population vector; matrix with 1 column!)
rownames(Initial_teasel) <- rownames(teasel_matrix)                  # add row and column names
colnames(Initial_teasel) <- "Abundance"
Initial_teasel

```


¡Entonces todo lo que tenemos que hacer es 'multiplicar por matriz' este **vector ** de abundancias por la **matriz de transición ** de arriba! ¡Cada vez que hacemos este paso de multiplicación, avanzamos un año! ¡Es fácil!

NOTA: la multiplicación de matrices (porcentaje-asterisco-porcentaje en R) no es lo mismo que la multiplicación estándar (asterisco en R). Repasaremos esto en la introducción al laboratorio 4 un poco más adelante.

¡Así es como podemos hacer esto en R!

```{r}

#########
# Project the population at time 1

Year1 <- teasel_matrix %*% Initial_teasel   # note: the '%*%' denotes 'matrix multiplication' in R. We'll go through this more later.     
Year1
  
```

¿Qué tan fácil es eso ?

Para calcular la abundancia de carmesí en el año 2 de nuestra simulación, simplemente podemos repetir:

```{r}

#########
# Project the population at time 2

thisYear <- Year1
nextYear <- teasel_matrix %*% thisYear
nextYear  # now we get the (age structured) population size at time 2!     

```

Podríamos usar esta estrategia para simular la abundancia durante diez años (o 20, o 30, o 10000) ...

¡Observe el uso de un **loop ** aquí!

```{r}

########
# Use a for loop to project the population dynamics for the next 10 years!

nYears <- 10
tenYears <- matrix(0,nrow=6,ncol=nYears+1)          # initialize storate array for recording age structured abundances for the next 10 years. 
rownames(tenYears) <- rownames(Initial_teasel)      # assign row and column names
colnames(tenYears) <- seq(0,10)
tenYears[,1] <- Initial_teasel                      # initialize the simulated abundances


##########
# run the for loop!

for(t in 2:(nYears+1)){    # here we use 't' as our looping variable, but we could choose any name we want
  tenYears[,t] <-  teasel_matrix %*% tenYears[,t-1]     # perform matrix multiplication for each year of the simulation!
}

tenYears


```

¡Finalmente, podemos trazar la abundancia de cada etapa durante 10 años!

```{r echo=FALSE}

#########
# Plot the projected population trajectory over the next 10 years 

plot(1,1,pch="",ylim=c(0,60000000),xlim=c(0,11),xlab="Years",ylab="Abundance",xaxt="n")    # make empty plot
cols <- rainbow(6)        # set colors for each stage
for(s in 1:6){
  points(tenYears[s,],col=cols[s],type="l",lwd=2)       # plot out each stage
}
axis(1,at=seq(1,11),labels = seq(0,10))      # add x axis labels
legend("topleft",col=cols,lwd=rep(2,6),legend=rownames(tenYears))      # add legend

```


¡Así que la proyección es fácil con matrices!

### Reason 3: Matrix algebra tricks!

There is a clear similarity between the finite population growth equation:

$N_{t+1}=\lambda \cdot N_t$,

where $N$ is abundance (as always), $t$ is time, often in years but could be any time units, and $\lambda$ is the multiplicative growth rate over the time period $t \rightarrow t+1$

... and the matrix population growth equation:

$\mathbf{N}_{t+1} = \mathbf{A} \cdot \mathbf{N}_{t}$,

where $\mathbf{N}$ is a **vector** of abundances (abundance for all stages), and $\mathbf{A}$ is the **transition matrix**, which we have seen before.

**Q:** Can you see the similarity between these two equations? 

Both equations describe simple exponential growth or decline!

**Q:** Can you see the difference between these two equations?

Note that $N$ in the first equation is a **scalar** -- that is, it is just a naked number with no additional components. 

WHEREAS,

$\mathbf{N}$ in the second equation is an age-structured **vector**: a set of abundances structured by age or stage class.

Similarly, the finite population growth rate, $\lambda$ is a scalar,

WHEREAS,

$\mathbf{A}$ is a **matrix** (the transition matrix)   

#### What about those tricks you promised??

Okay one of the tricks is this:

In one step, you can compute $\lambda$ from $\mathbf{A}$!!     

All you need to do is obtain the _first, or dominant, **eigenvalue** of $\mathbf{A}$_! This number is the finite rate of growth, $\lambda$, for an age or stage-structured population.

Recall that when a population is at stable age distribution, it grows in a discrete exponential growth pattern- this rate of exponential growth can be described by a single parameter -- Lambda!  

Let's do this in R!

What is the growth rate $\lambda$ for the teasel population. If you recall, it looked like it was growing, so it should be above 1...

```{r}

###########
# Use the transition matrix to compute Lambda, or the finite rate of population growth!

Lambda <- as.numeric(round(eigen(teasel_matrix)$values[1],2))
Lambda

```

Or we could use the handy "popbio" package in R:    

```{r}


library(popbio)      # or... it's easier to use the 'popbio' library in R!
lambda(teasel_matrix)

```


You don't have to understand the math here- but I do want you to understand how simple that was- just one line of code and we computed the annual rate of growth from the teasel transition matrix!

Here's another nifty trick:

In one step, you can compute **stable age distribution (S.A.D)** from $\mathbf{A}$!!     

All you need to do is obtain the _right-hand eigenvector of $\mathbf{A}$_! This vector represents the _relative abundances in each age class at the stable age distribution_. 

Let's do this in R!

What is the stable age distribution for the teasel population. If you recall, the first seed stage looked like it dominated in the figure above.

```{r}

##########
# Compute stable age distribution from the transition matrix!

SAD <- abs(as.numeric(round(eigen(teasel_matrix)$vectors[,1],3)))
SAD/sum(SAD)      # stable age distribution as a percentage of the total population

```

Or you can use the 'popbio' package in R:

```{r}

library(popbio)    # ... and it's even easier if we use the 'popbio' package...
stable.stage(teasel_matrix)


```

**Q:** Does a stage-structured population grow at the rate of $\lambda$ per time step if it is NOT at stable age distribution? [tophat]   

To answer this question, you may find it helps to load an stage-structured model in InsightMaker like [this one](https://insightmaker.com/insight/70809/Age-structured-population)). 

## Mechanics of matrix population models

Let's take a look at a basic age-structured population -- specifically the in-class example from the last lecture ([this one](https://insightmaker.com/insight/70809/Age-structured-population).). In InsightMaker it looks something like this:

![](IM9.jpg)

Let's convert the vital rates to a three-stage **projection matrix**. Projection matrices are **square matrices** where the number of rows and columns are equal to the number of life stages. In this case, that means three! Let's make a blank matrix for now:

```{r}

###################
# In class demo: convert an insightmaker model to a matrix projection model


###########
# First, we specify a blank transition matrix

TMat <- matrix(0,nrow=3,ncol=3)                    # create a blank matrix with 3 rows and 3 columns
stagenames <- c("Juveniles","Subadults","Adults")  # name the rows and columns
rownames(TMat) <- stagenames
colnames(TMat) <- stagenames
TMat                                               # now we have an all-zero transition matrix.

```

You can read the **elements** of a transition matrix as follows:

"The per-capita production of _(row name)_ by _(col name)_ is _(value of element)_"         

Now we can start filling in this matrix. Let's begin with the top left **element** of the matrix. This represents the per-capita production of Juveniles (col) by Juveniles (row). What is the value of this element? 

Let's update our transition matrix:

```{r}

#####
# fill in the top left element of the matrix

TMat[1,1] <- 0
TMat

```

How about the second row, first column. This represents the per-capita production of Subadults (row) by previous-year Juveniles (col). That is, the transition rate from juvenile to subadult. The value from our model is 0.3. 

Let's update our transition matrix:

```{r}

#####
# update the second row, first column

TMat[2,1] <- 0.3
TMat

```

If we keep going, we get the following matrix. See if you can understand what this matrix is saying about the transitions from and two the three life stages. 

```{r}

#####
# and keep filling it in...

TMat[,1] <- c(0,0.3,0)          # fill in the entire first column of the transition matrix
TMat[,2] <- c(0,0.4,0.1)        # fill in the entire second column of the transition matrix
TMat[,3] <- c(4,0,0.85)         # fill in the entire third column of the transition matrix
TMat

```

Now we can run a 40-year projection and compare it with the InsightMaker model. It had better look the same!!

First we must specify the initial abundances in each stage:

```{r}

######
# specify initial abundance vector

InitAbund <- c(40,0,0)
names(InitAbund) <- colnames(TMat)
InitAbund

```

So we are starting with only Juveniles...

```{r}

#######
# Run the model for 40 years (using for loop)

nYears <- 40
allYears <- matrix(0,nrow=nrow(TMat),ncol=nYears+1)
rownames(allYears) <- rownames(TMat)
colnames(allYears) <- seq(0,nYears)
allYears[,1] <- InitAbund 

for(t in 2:(nYears+1)){
  allYears[,t] <-  TMat %*% allYears[,t-1]
}

allYears

```


Now let's plot it out!

```{r}

#####
# and plot out the results!

plot(1,1,pch="",ylim=c(0,50),xlim=c(0,nYears+1),xlab="Years",ylab="Abundance",xaxt="n")
cols <- rainbow(3)
for(s in 1:3){
  points(allYears[s,],col=cols[s],type="l",lwd=2)
}
axis(1,at=seq(1,nYears+1),labels = seq(0,nYears))
legend("topleft",col=cols,lwd=rep(2,3),legend=rownames(allYears))

```

Does this look the same as the InsightMaker results?

## Limitations of matrix population models

Matrix population models are great, but they have some limitations too. 

### What about density-dependence?

In some ways, while introducing a new level of realism in our models -- age-structure -- we have been ignoring another type of realism that we introduced in earlier lectures- **density-dependence**!

Which vital rates are density-dependent? All? Some? It depends? Are the data available?

How do you incorporate density-dependence into a matrix population model?  

How do you incorporate predator-prey dynamics into a matrix population model? [cue brain explosion]     

_Whatever you can do with a matrix population model, you can also do in InsightMaker (or R, or any other programming platform)_ (but it might not be as 'pretty' or elegant as a matrix population model!)

The reverse is NOT true: **you can not always convert InsightMaker models to matrix population models** (IM is a programming language, so is much more flexible!)   

### Review of matrix multiplication

(on the whiteboard during lab!) (I will post the video demo to webcampus)

### In-class exercise: matrix projection models

Translate the following paragraph into a matrix population model. Remember a matrix population model has two components- an **initial abundance vector** and a **transition matrix**.  

NOTE: this is also a question in Lab 4!


![](redtail1.jpg)

> We assumed that the red-tailed hawk life history could be described in terms of three major life stages: hatchling (first year of life), juvenile (largely individuals in their second year of life), and adult (generally the third year of life and beyond). Adults are the primary reproductive stage, and produce an average of 3 new hatchlings each year. Juveniles are expected to produce only 1 new hatchling each year. We assumed that adults experienced an average of 18% mortality each year. Juvenile mortality was set at 30% per year. Approximately 5% of juveniles remain in the juvenile phase each year, and all other survivors transition to the adult stage. Finally, hatchlings had a 20% chance of surviving and transitioning to become juveniles. We initialized the population with 1000 hatchlings, 150 juveniles, and 5 adults. 

**Q:** What does the transition matrix look like? [tophat]

**Q:** What does the initial stage abundance vector look like?

**Q:** Is this population at a stable stage-distribution?

**Q:** What is the growth rate of this population? 

For more on matrix population models, the bible of this subject is [this book by Hal Caswell](https://www.amazon.com/gp/huc/view.html?ie=UTF8&newItems=C1DH1414B1C6AK%2C1).

And finally, check this out- this is a database of thousands of stage matrices for plants and animals around the world:

[COMADRE and COMPADRE databases](https://compadredb.wordpress.com/2015/10/05/introducing-the-comadre-animal-matrix-database/)


[--go to next lecture--](LECTURE8.html)
























